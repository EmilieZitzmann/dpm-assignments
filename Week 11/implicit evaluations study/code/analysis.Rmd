---
title: "Evaluations of positive and negative stimuli using the Affective Misattribution Procedure (AMP) and self-reports"
subtitle: "Analysis"
author: "Template: Ian Hussey; content: Emilie"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

# set knit options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# disable scientific notation
options(scipen = 999) 

```

# Dependencies

```{r}

library(tidyverse)
library(knitr)
library(kableExtra)
library(janitor)
library(scales)

```

# Data

Load the processed data and apply the global exclusions.

```{r}

data_processed <- read_csv("../data/processed/data_processed.csv")

data_processed_after_exclusions <- data_processed |>
  filter(exclude_participant == "include")

```

# Sample descriptives

## Sample size before exclusions

```{r}

data_processed |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("Whole sample" = 1)) |> # note that you can add header rows to tables like this. The "1" indicates the number of columns the header should span. The sum of these numbers must equal the number of columns or you'll get an error.
  kable_classic(full_width = FALSE)

```

## Sample size after exclusions

Sample used in subsequent analyses

```{r}

data_processed_after_exclusions |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("For analysis" = 1)) |>
  kable_classic(full_width = FALSE)

```

## Age

```{r}

data_processed_after_exclusions |>
  mutate(age = as.numeric(age)) |>
  summarise(Mean = mean(age, na.rm = TRUE),
            SD = sd(age, na.rm = TRUE)) |>
  mutate_all(.funs = janitor::round_half_up, digits = 1) |>
  kable() |>
  add_header_above(header = c("Age" = 2)) |>
  kable_classic(full_width = FALSE)

```

## Gender

```{r}

data_processed_after_exclusions |> 
  rename(Gender = gender) |>
  group_by(Gender) |> 
  summarise(n = n()) |> 
  mutate(Percent = paste0(round_half_up((n / sum(n)) * 100, 1), "%")) |>
  mutate(Gender = stringr::str_to_sentence(Gender)) |> # Change the case of the Gender variable so that it prints nicely
  kable() |>
  kable_classic(full_width = FALSE)

```

# Descriptives

Descriptive statistics and plots of the measures (excluding the demographics variables)

## Self-reported evaluations

### Descriptive stats

```{r}

# overall self-reported evaluations
dat_mean_ratings <- data_processed_after_exclusions |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n()) |>
  mutate(group = "Full sample")

# self-reported evaluations by gender category
dat_mean_ratings_by_gender <- data_processed_after_exclusions |>
  group_by(group = gender) |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n())

# combine both into one table
bind_rows(dat_mean_ratings,
          dat_mean_ratings_by_gender) |>
  select(Subset = group, Mean, SD, n) |> # select variables of interest, and rename one 
  mutate(Subset = stringr::str_to_sentence(Subset)) |> # Change the case of the Subset variable so that it prints nicely
  mutate_if(is.numeric, round_half_up, digits = 2) |>
  kable() |>
  add_header_above(header = c(" " = 1, "Self-reported evaluations" = 3)) |>
  kable_classic(full_width = FALSE)

```

### Descriptive plot

```{r}

ggplot(data_processed_after_exclusions, aes(x = mean_evaluation)) +
  geom_histogram(binwidth = 1,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("Mean self-reported evaluation") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 7)) +
  coord_cartesian(xlim = c(1, 7)) +
  theme(panel.grid.minor = element_blank())

```

## AMP evaluations

### Descriptive stats

\TODO add table of means, SDs, Ns

```{r}

### Descriptive stats

# all self evluations 

dat_mean_ratings <- data_processed_after_exclusions |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n()) |>
  mutate(group = "Full sample")

# by gender
dat_mean_ratings_by_gender <- data_processed_after_exclusions |>
  group_by(group = gender) |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n())

# combine
bind_rows(dat_mean_ratings,
          dat_mean_ratings_by_gender) |>
  select(Subset = group, Mean, SD, n) |> 
  mutate(Subset = stringr::str_to_sentence(Subset)) |> 
  mutate_if(is.numeric, round_half_up, digits = 2) |>
  kable() |>
  add_header_above(header = c(" " = 1, "AMP Evaluations" = 3)) |>
  kable_classic(full_width = FALSE)

```

### Descriptive plots

```{r}

ggplot(data_processed_after_exclusions, aes(x = AMP_score)) +
  geom_histogram(binwidth = 0.05,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("AMP score") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))

```

# Analyses & hypothesis tests

## Self-reported evaluations are correlated with evaluations on the AMP

### Plot

```{r}

ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score,
           y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  geom_smooth(method = "lm",
              color = viridis_pal(begin = 0.45, option = "mako")(1)) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw() 

ggplot(data_processed_after_exclusions, 
       aes(y = AMP_score,
           x = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  geom_smooth(method = "lm",
              color = viridis_pal(begin = 0.45, option = "mako")(1)) +
  ylab("AMP score") +
  xlab("Mean self-reported evaluation") +
  theme_linedraw() 

ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score,
           y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw() 

```

More complex plots:

#### Axial hisograms

Scatter plots with axial histograms using ggExtra: https://cran.r-project.org/web/packages/ggExtra/vignettes/ggExtra.html

\TODO add axial histograms to a scatter plot. In a single plot, present different regression lines split by gender, and separate axial histograms for each gender.

```{r}
library("ggExtra")
library("ggplot2")


#creating a plot 
plot1 <- ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score,
           y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw() 

ggMarginal(plot1, type = "histogram")


#Split them by gender and add regression line 

Axial_histogram_gender <- ggplot(data_processed_after_exclusions, 
                                  aes(x = AMP_score,
                                      y = mean_evaluation, 
                                      colour = gender)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "pink") +  # Add regression line
  scale_colour_discrete(name = "gender",
                        labels = c("female", "male", "non-binary")) +
  theme(legend.position = c(.15, .7))

ggMarginal(Axial_histogram_gender, type = "histogram", groupColour = TRUE, groupFill = TRUE)


#The regression line kinda shows a negative trend --> important to observe a first trend 

```

#### Labelled points

Label points using ggrepel: https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html

\TODO Label the points in a scatter plot using their participant codes. Label only the participants with more extreme scores.

To change colors use:

```{r eval=FALSE, include=FALSE}
##colors 
colors <- viridis_pal(begin = 0.0, end = 1.0, option = "mako")(10)
colors
show_col(colors)
```


```{r}
library(ggrepel)
```


```{r}

#Plot 
Point_labels <- ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score,
           y = mean_evaluation, 
           label = subject)) +
  geom_point (color = "red") +
  scale_colour_discrete(name = "gender",
                        labels = c("female", "male", "non-binary"))

set.seed(42)

p1 <- Point_labels + geom_text() + labs(title = "geom_text()")

p2 <- Point_labels + geom_text_repel() + labs(title = "geom_text_repel()")

gridExtra::grid.arrange(p1, p2, ncol = 2)

#R itself gives us a warning, that there are unlabeled data points and too many overlaps, so this plot is not really useful 
#a way this plot is often used is to show the outliers or identify them, this is easily done by just putting the outlier variable or an order reporting the outliers directly in to the ggplot 


```

#### Magnify areas

Magnify areas of your plot with ggmagnify: https://hughjonesd.github.io/ggmagnify/

\TODO Magnify an area of one of your scatter plots, eg where there are a lot of data points in a small area.

```{r}
# Load necessary libraries
library(ggplot2)
library(ggmagnify)

# Your original scatter plot
ggp <- ggplot(data_processed_after_exclusions, aes(x = AMP_score, y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1), alpha = 0.5) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw()

# Define the area to be magnified
# Adjust these values to the area you want to zoom in on
from <- c(xmin = 0.3, xmax = 0.8, ymin = 0.8, ymax = 1.3)

# Define where to place the magnified inset on the plot
# Adjust these values to place the inset where you like
to <- c(xmin = 0, xmax = 0.25, ymin = 4, ymax = 5)

# Add the magnified area to the plot
ggp + geom_magnify(from = from, to = to)
```
### Test

\TODO run an appropriate test. Below the output, interpret the results: write a few sentences that report and interpret the results following APA reporting style.
Statistical inference test ---> Test stats and p value 
Hypothesis: Self-reported evaluations are correlated with evaluations on the AMP

```{r}

# In order tot check wether self report evaluations are correlated with the amp evaluations we remember the regression line above where we saw a slight negative trend We should test this statistically 
result <- cor.test(data_processed_after_exclusions$mean_evaluation, data_processed_after_exclusions$AMP_score, method = "pearson")

# Print the test statistics and p-value
print(result)
#if we want the results specifically
 result$p.value
 result$estimate

#we see a negative correlation however it is not significant (p = .2435), also seen in confidence interval that includes 0 suggesting that there is no correlation in the data 

# we can alos check for a spearman correlation test
 result2 <- cor.test(data_processed_after_exclusions$mean_evaluation, data_processed_after_exclusions$AMP_score, method = "spearman")

 result2$p.value
 result2$estimate

 
#for the spearman it is almost identical (not surprisingly)

```

## Self-reported evalautions differ between men and women

### Plot

\TODO split histogram, split violin plot, raincloud plot, etc.

```{r}
#####split histogram

# Create a first layer base plot
splithistogram <- ggplot(data_processed_after_exclusions, aes(x = AMP_score, fill = gender)) +
  geom_histogram(position = "dodge", binwidth = 0.15, color = "black", alpha = 0.7) + # Add black borders and some transparency
  facet_grid(. ~ gender) + # Splitting the histogram by gender
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_minimal() +
  theme(legend.position = c(0.8, 0.8), legend.background = element_rect(fill = "white"))

# Print the plot
print(splithistogram)

#the first plot shows a slight difference in the mean with male participants having more of a typical distribution and women having slightly lower scores 



#####Violin plot

splitviolin <- ggplot(data_processed_after_exclusions, aes(x = gender, y = AMP_score, fill = gender)) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.7, color = "black") + # Adjusting width, adding transparency, and black borders
  geom_boxplot(width = 0.1, fill = "white", color = "black", alpha = 0.7) + # Enhancing boxplot appearance
  facet_wrap(~gender, scales = "free_x") + # Splitting by gender
  xlab("Gender") +
  ylab("AMP Score") +
  theme_minimal() +
  theme(legend.position = c(0.8, 0.8), legend.background = element_rect(fill = "white"))

# Print the plot
print(splitviolin)

#This plot shows a bit more information: the central tendencies of the two are quite the same (the center), also the density seems quite the same (= shape shows the distribution of AMP Scores), but the female measures have a bit lower scores (we could already see that in the histogram)
#Men do have a slightly higher amount of outliers 
#Boxplot for women is a bit bigger, median seems about the same
#


#####raincloud plot
# necessary packages 
library(ggplot2)
library(ggdist) #We could use this to do a flat violin 
library(ggbeeswarm)


raincloudplot <- ggplot(data_processed_after_exclusions, aes(x = gender, y = AMP_score, fill = gender)) +
    # Add a half violin plot
    geom_violin(trim = FALSE, scale = "area", adjust = 1.5, alpha = 0.5) +
    # Add the boxplot
    geom_boxplot(width = 0.1, outlier.shape = NA, alpha = 0.5) +
    # Add points
    geom_quasirandom(aes(color = gender), size = 2, alpha = 0.5, show.legend = FALSE) +
    # Customizations
    scale_color_brewer(palette = "Dark2") +
    scale_fill_brewer(palette = "Dark2") +
    labs(x = "Gender", y = "AMP Score") +
    theme_minimal()

# Print the plot
print(raincloudplot)


#The information provided here is somewhat different again: we have the information of the violin plots before (median about the same etc.), the added information here are the distribution points that we have "extra" --> we can see that where the width increases we have more differing points (this is obvious since the width is there to represent this exact thing), yet we can see that there seems more differing points for men and less for women

#all in all I don't really think that there is a difference between AMP Scores in men and women but let's find out by running the statistical test 
```

### Test

\TODO run an appropriate test. Below the output, interpret the results: write a few sentences that report and interpret the results following APA reporting style.
Self-reported evalautions differ between men and women 

```{r}
#Since our factor has more than 2 layers (Stufen) we have to conduct an anova, but the anova does not work either, because we have a lot of measures (sometimes it returns no p-value, or value = NULL). The kruskal result avoids that (This tests whether there are significant differences between two or more groups --> since we have nonbinary in our dataset as well we use this one)

# Assume 'data' is your dataset with columns 'AMP_score' and 'gender'
kruskal_result <- kruskal.test(AMP_score ~ gender, data = data_processed_after_exclusions)

# Print the result
print(kruskal_result)

#Not surprisingly there is no significant difference with p equaling .9841 


```

## Evaluations on the Affect Misattribution Procedure differ between men and women

### Plot

\TODO split histogram, split violin plot, raincloud plot, etc.

This time, vary the labeling and order of the legend, e.g., capitalise "Men" and "Women", and know how to change the order of the factors.

```{r}
#####Split Histogram 
#vary the labeling and order of the legend 
#To vary the labeling we can easily convert two vectors and include them into the plot --> for each plot we can include the labels like that 

# Define custom labels and order for the legend
custom_labels <- c("Women", "Men", "Nonbinary")
custom_order <- c("female", "male", "non-binary")

# Create the split histogram plot with modified legend
splithistogram2 <- ggplot(data_processed_after_exclusions, aes(x = AMP_score, fill = gender)) +
  geom_histogram(position = "dodge", binwidth = 0.15, color = "black", alpha = 0.7) +
  facet_grid(. ~ gender) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_minimal() +
  theme(legend.position = c(0.8, 0.8), legend.background = element_rect(fill = "white")) +
  scale_fill_manual(values = c("female" = "red", "male" = "blue", "non-binary" = "green"),  # Adjust colors if needed
                    labels = custom_labels,
                    breaks = custom_order)

# Print the plot
print(splithistogram2)


splithistogram2 <- ggplot(data_processed_after_exclusions, aes(x = AMP_score, fill = gender)) +
  geom_histogram(position = "dodge", binwidth = 0.15, color = "black", alpha = 0.7) + # Add black borders and some transparency
  facet_grid(. ~ gender) + # Splitting the histogram by gender
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_minimal() +
  theme(legend.position = c(0.8, 0.8), legend.background = element_rect(fill = "white"))

# Print the plot
print(splithistogram2)


```

### Test

\TODO run an appropriate test. Below the output, print an interpretation of the results generated by the 'easystats' package [report](https://easystats.github.io/report/). I.e., use `report::report()`.

```{r}



```

## Combining plots

Combine plots using the library [patchwork](https://patchwork.data-imaginist.com/).

\TODO Combine at least three of the above plots into one.

```{r}



```

## Saving plots

Save plots to disk with `ggsave()`

\TODO Save the above combined plot to disk as both .png and .pdf. Ensure the png has at least 300dpi resolution.

```{r}



```

# Session info

```{r}

sessionInfo()

```



